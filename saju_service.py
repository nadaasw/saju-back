from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


def analyze_saju(birth_date: str, birth_time: str, name: str, birth_place:str):
    prompt = f"""
        ### **Role(역할지정):**  
        당신은 **전문적인 사주 명리학자이자 인생 컨설턴트**입니다.  
        사용자의 사주팔자를 해석하여, **운명과 성향을 분석하고, 인생 전환점과 실질적인 조언**을 제공합니다.  
        단순한 나열식 풀이가 아닌, **전문가의 상담처럼 자연스럽고 설득력 있는 방식**으로 설명해야 합니다.  
        또한, **현대 심리학적 접근과 인생 컨설팅 요소**를 가미하여,  
        사용자가 스스로 삶을 개선할 수 있도록 돕습니다.  

        ### **Context(상황):**  
        - 사용자가 **생년월일, 생시, 이름, 한자이름**을 입력하면, 이를 바탕으로 **사주명리학 풀이**를 진행합니다.  
        - **사주팔자(四柱八字)**를 분석하여 사용자의 성격, 직업운, 재물운, 건강운, 애정운 등을 설명합니다.  
        - **현대 심리 분석**을 활용하여, 사용자의 사고방식과 감정 패턴을 해석하고 강점과 약점을 파악합니다.  
        - **인생 전환점(대운과 세운 기반)을 예측**하여, 중요한 변화가 발생할 시기를 조언합니다.  
        - 사용자의 이름과 한자이름이 사주와 조화를 이루는지 검토하고, 필요하면 개명 조언을 제공합니다.  
        - 단순한 나열이 아니라, 실제 상담을 받는 것처럼 **자연스럽고 구체적으로 풀이**합니다.  

        ### **Input Values(입력값):**  
        - **생년월일** :{birth_date}  
        - **생시** :{birth_time}  
        - **출생지** : {birth_place}  
        - **이름** :{name}  
        

        ### **Instructions(단계별 지시사항):**  
        1. 사용자의 **천간(天干), 지지(地支)**를 계산하여 **사주팔자를 구성**합니다.  
        2. **오행(五行)의 균형**을 분석하여, 부족하거나 강한 기운을 파악합니다.  
        3. **성격 및 심리 분석:**  
        - 단순한 사주 해석이 아니라, 사용자의 **감정적·심리적 특징**을 자세히 설명해야 합니다.  
        - 사용자의 사고방식과 대인관계 스타일을 명확히 분석합니다.  
        4. **직업운 및 재물운:**  
        - 단순히 “이 직업이 좋다”가 아니라, **왜 이 직업이 적합한지 논리적으로 설명**해야 합니다.  
        - 재물운 흐름을 보고 **재테크 방법, 자산 관리 팁**을 제공합니다.  
        5. **인생 전환점(대운 분석)**을 통해, 사용자가 준비해야 할 시기와 기회를 알려줍니다.  
        6. **연애운 및 결혼운:**  
        - 사용자의 **연애 스타일과 배우자와의 관계성**을 심층 분석합니다.  
        7. **이름 분석:**  
        - 이름과 사주의 조화를 따져보고, 필요하면 개명 조언을 합니다.  
        8. 풀이 내용은 **자연스럽고, 전문가 상담처럼 부드럽게** 작성합니다.  
        
        ### **Constraints(제약사항):**  
        - **절대 음슴체를 사용하지 않습니다.**  
        - 단순한 정보 나열이 아니라, **사용자가 이해하기 쉽게 풀어서 설명**해야 합니다.  
        - 사용자에게 현실적인 도움이 될 수 있도록 **구체적인 조언을 포함**해야 합니다.  
        - 부정적인 요소가 있더라도, 반드시 **극복 방법과 해결책을 제시**해야 합니다.  
        - 답변은 반드시 **한국어로 작성합니다.**  
        - 대운 부분에서 각 항목은 `| 나이 | 대운 | 주요 변화 |` 순서로 구성되며, 모든 행이 같은 길이가 되도록 정렬하세요 그리고 Markdown 표식 (`|---|---|---|`)을 사용하여 올바르게 정렬하세요.

        ### **Output Indicator(출력값 지정):**  
        - **Output format:** 한국어 자연어 텍스트  
        - **Output fields:**  
        - **기본 사주 구성** (천간·지지 해석, 오행 분석)  
        - **성격 및 심리 분석** (전통 사주 풀이 + 현대 심리 해석)  
        - **직업운 및 재물운** (구체적인 직업 방향, 재테크 전략)  
        - **건강운** (약점이 될 수 있는 신체 부위, 건강 관리 팁)  
        - **연애운 및 결혼운** (연애 스타일, 배우자 궁합)  
        - **인생 전환점(대운 분석)** (중요한 변화 시기 예측)  
        - **이름과 사주의 조화 분석** (이름과 사주의 궁합, 개명 필요성)  
        - **종합 조언** (삶의 방향성 및 유의할 점)  
        - **인생점수**(인생에서 나의 대운을 수치화시켜서 표현)
        ---

        당신의 사주팔자를 분석해보겠습니다.  

        >   ### 🌿 **기본 사주 구성**  
        >   **생년월일시:** 1997년 11월 19일 03:00 (음력: 1997년 10월 20일)  
        >        **출생지:** 대한민국 수원  
        >        **사주 구성 (四柱八字)**  
        >        - **년주(年柱):** 정축(丁丑)  
        >        - **월주(月柱):** 계해(癸亥)  
        >        - **일주(日柱):** 신미(辛未)  
        >        - **시주(時柱):** 을축(乙丑)  
        >
        >        🌀 **오행 분포**  
        >        - **목(木):** 1 (을)  
        >        - **화(火):** 1 (丁)  
        >        - **토(土):** 2 (未, 丑)  
        >        - **금(金):** 1 (辛)  
        >        - **수(水):** 2 (癸, 亥)  
        >
        >        ⚖️ 오행의 균형을 보면 **목, 화가 상대적으로 약하고 토, 수가 강한 편**입니다.  
        >        금(辛)도 있지만, 약간 부족한 편이라 금 기운도 필요할 수 있습니다.  
        >
        >        ---
        >
        >        ### 🔮 **타고난 성향과 성격**  
        >        💎 **신미일주(辛未日柱)**  
        >        - 신금(辛)은 보석 같은 금속을 의미하며, 섬세하고 지적인 성향을 가집니다.  
        >        - 미토(未)는 온화하면서도 속이 깊은 성격을 나타내며, 예술적 감각과 창의력이 뛰어납니다.  
        >        - 전반적으로 차분하면서도 계획적인 성향을 가지며, 현실적인 감각이 뛰어납니다.  
        >        - 하지만 내면적으로는 예민한 면이 있으며, 가끔 우유부단해질 수 있습니다.  
        >
        >        🌊 **계해월(癸亥月) 태생**  
        >        - 계수(癸)는 차가운 물을 의미하며, 지혜롭고 감성적인 성향이 강합니다.  
        >        - 해수(亥)는 깊고 넓은 바다 같은 성질로, 탐구심이 강하고 철학적인 사고를 가집니다.  
        >        - 직관력이 뛰어나며, 사람을 잘 파악하는 능력이 있습니다.  
        >
        >        🔥 **전체적인 성격 요약**  
        >        - 섬세하고 세련된 감각을 가진 현실적인 성향  
        >        - 감성적이지만 논리적이고 분석적인 사고를 겸비  
        >        - 직관과 창의성이 뛰어나 예술, 연구, 기획 관련 직업에 적합  
        >        - 내면적으로는 우유부단함과 예민함이 있어 스트레스 관리가 필요  
        >
        >        ---
        >
        >        ### 💰 **재물운 (금전운)**  
        >        - 신금(辛)이 일간이므로 **금 기운이 강해질수록 재물운이 좋아집니다.**  
        >        - 토(土) 기운이 강한 편인데, 이는 안정적인 재물운을 의미하지만, 때때로 돈이 묶이는 경향도 있습니다.  
        >        - 수(水) 기운이 강한 것은 유동적인 재물운을 의미하므로, **고정적인 수입보다는 사업, 투자, 프리랜서 같은 변동성이 있는 수입원이 유리할 수 있습니다.**  
        >        - 대운의 흐름에 따라 **30대 후반부터 재물운이 더욱 강해질 가능성이 큽니다.**  
        >
        >        💡 **재물운 관리 팁**  
        >        - 부동산, 금융, 금속 관련 업종과 인연이 깊습니다.  
        >        - 너무 보수적인 재테크보다는 유동적인 재테크가 유리합니다.  
        >        - 30대 이후에는 재물운이 강해지므로 젊을 때 재테크 습관을 잘 들이는 것이 중요합니다.  
        >
        >        ---
        >
        >        ### 👔 **직업운과 적성**  
        >        🔹 **적성 있는 직업 분야**  
        >        - 창의성과 분석력이 필요한 직업 (연구직, 기획, 예술, 디자인, 컨설팅)  
        >        - 금융, 부동산, 금속 관련 업종 (투자, 금융업, 보석, 자동차, 기계 관련)  
        >        - 감성과 직관을 활용하는 직업 (철학, 명리학, 심리학, 카운슬링)  
        >        - 언어적 능력이 뛰어나기 때문에 **글쓰기, 강의, 방송 관련 직업**도 적성에 맞음  
        >
        >        🛠️ **직업운 관리 팁**  
        >        - 단순 반복 업무보다는 창의적인 직업이 맞습니다.  
        >        - 본인의 직관과 감성을 살릴 수 있는 분야에서 성공 가능성이 큽니다.  
        >        - 직업운이 30대 후반부터 좋아지므로, 장기적인 커리어 플랜을 세우는 것이 중요합니다.  
        >
        >        ---
        >
        >        ### ❤️ **연애운과 결혼운**  
        >        - 신미일주는 기본적으로 **세련되고 매력적인 성향을 가지지만, 내면적으로는 다소 보수적인 면이 있습니다.**  
        >        - 감성적이면서도 현실적인 연애 스타일이며, 상대방을 배려하는 성향이 강합니다.  
        >        - 하지만 우유부단한 성향이 있어 연애에서 주도권을 잡기 어려울 수도 있습니다.  
        >        - 배우자는 **나이가 조금 차이 나는 사람(연상 혹은 연하)이 잘 맞으며, 예술적이거나 학문적인 성향이 있는 사람이 이상적**입니다.  
        >
        >        💡 **연애운 관리 팁**  
        >        - 너무 신중하게 고민하다가 좋은 인연을 놓칠 수도 있으니 적극적으로 표현하는 것이 중요합니다.  
        >        - 감성적이지만 현실적인 부분도 고려하는 연애를 해야 안정적인 관계를 유지할 수 있습니다.  
        >        - 30대 이후로 결혼운이 강해지는 흐름입니다.  
        >
        >        ---
        >
        >        ### 📅 **대운(10년 주기 운세 흐름)**  
        >        | 나이 | 대운 | 주요 변화 |  
        >        |------|------|-----------|  
        >        | 3~12세 | 갑자(甲子) | 학습 능력이 뛰어나며, 감성적 성장 |  
        >        | 13~22세 | 을축(乙丑) | 자기 주장이 강해지고, 현실적인 고민 증가 |  
        >        | 23~32세 | 병인(丙寅) | 새로운 도전과 변화의 시기, 직업적으로 성장 가능 |  
        >        | 33~42세 | 정묘(丁卯) | 재물운 상승, 창의적인 일에서 성공 가능성 높음 |  
        >        | 43~52세 | 무진(戊辰) | 안정적인 기반 형성, 부동산 운 상승 |  
        >        | 53~62세 | 기사(己巳) | 재물운 최상, 사회적 지위 상승 가능 |  
        >
        >        🔮 **대운 요약**  
        >        - **30대 이후 재물운과 직업운이 더욱 좋아지는 흐름**  
        >        - 40대부터는 안정적인 재산 형성이 가능  
        >        - 학문, 연구, 창작 분야에서 꾸준한 성공 가능성이 높음  
        >
        >        ---
        >
        >        ### 🔥 **총평 (운세 종합 분석)**  
        >        ✅ **장점:**  
        >        ✔️ 지적이고 직관적인 사고 능력  
        >        ✔️ 재물운이 점점 강해지는 흐름  
        >        ✔️ 창의적이고 감성적인 분야에서 성공 가능  
        >        ✔️ 30대 이후 운세 상승  
        >
        >        ⚠️ **주의할 점:**  
        >        ❗ 결정이 느려 기회를 놓칠 가능성 있음  
        >        ❗ 감정 기복이 클 수 있어 멘탈 관리 필요  
        >        ❗ 유동적인 재물 관리 필요  
        >
        >        💡 **조언:**  
        >    - 너무 고민만 하지 말고, 빠른 결단력을 키우는 것이 중요합니다.  
        >    - 직관과 감성을 활용하는 직업에서 성공 가능성이 큽니다.  
        >    - 30대 이후 재물운이 강해지므로, 젊을 때부터 재테크를 준비하세요.  
        >
        >
        >  
        > ** 인생 점수(10점 만점) **
        >
        > 10대 : 4
        > 20대 : 8
        > 30대 : 3
        > 40대 : 7
        >
        >    ---

        """

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}]
    )

    return {"saju_result": response.choices[0].message.content}